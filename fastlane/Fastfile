# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#A03

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

   lane :a03 do |options|
	build_number = "#{options[:BUILD]}"
	environment = ENV['ENVIRMENT']
    configration = ENV['CONFIGRATION']
 # æµ‹è¯•æ¨¡å¼ true/false
    isTestMode = false
    if isTestMode
        @receiverName = "ieandy"
    else
        @receiverName = "{FD375D42-F34C-43C9-951C-334F1510A69B}"
	gym(scheme: ENV['SCHEME'],
		workspace: ENV['WORKSPACE'],
		clean:true,
		configuration: ENV['CONFIGRATION'],
		export_method: "ad-hoc",
		output_directory:"./apps",
		output_name:"#{ENV['APP_NAME']}#{get_version_number}.#{build_number}")
    end
	appName = "#{ENV['APP_NAME']}#{get_version_number}.#{build_number}"
    callOut_Main(BUILD: build_number , NAME:appName , ENVIR:environment , CONF:configration)
   end

   lane :callOut_Main do |options|
    commandMessage = ""
# äº§å“ç¼–å·
	app_version = get_version_number
# äº§å“Buildç¼–å·
	build_number = "#{options[:BUILD]}"
# äº§å“åç§°
	ipa_Name = "#{options[:NAME]}"
# äº§å“ç¯å¢ƒ
	environment = "#{options[:ENVIR]}"
# äº§å“è¨­å®š
    configration = "#{options[:CONF]}"
# è¦ä¸‹è¼‰çš„ç¶²å€
	download_url = "itms-services://?action=download-manifest&url=https://10.82.64.200:9000/plist/A03/#{ipa_Name}"
    qrcode_download_url = "itms-services://?action=download-manifest\\&url=https://10.82.64.200:9000/plist/A03/#{ipa_Name}"
# å½“å‰Gitåç§°
	git_branch_name = git_branch 
# æœ€åCommitå†…å®¹
	commit = last_git_commit
# Gitä½œè€…
	author = commit[:author] # author of the commit
# æœ€åGitå†…å®¹
	message = commit[:message] # message of the commit
# Gitä½œè€…Email
	author_email = commit[:author_email] # email of the author of the commit
# Git hash
	hash = commit[:commit_hash] # long sha of commit
# Git short hash
	short_hash = commit[:abbreviated_commit_hash] # short sha of commit

	puts ("å½“å‰Gitåç§° #{git_branch_name}")
	puts ("Gitä½œè€… #{author}")
	puts ("æœ€åGitå†…å®¹ #{message}")
	puts ("Gitä½œè€…Email #{author_email}")
	puts ("Git hash #{hash}")
	puts ("Git short hash #{short_hash}")
	puts "app äº§å“ç¼–å·: #{app_version} "
	puts "app buildè™Ÿ: #{build_number} "
	puts "app äº§å“åç§°: #{ipa_Name} "
	puts "app è¦ä¸‹è¼‰çš„ç¶²å€: #{download_url} "

	sh "pwd" # => "[root]/fastlane"
	puts Dir.pwd # => "[root]/fastlane"
	qrCodeImagePath = Dir.pwd + "/qrCode.png"
	puts "äºŒç»´ç å›¾ç‰‡pathï¼š #{qrCodeImagePath} "
# ç”¢ç”Ÿ QRCode åœ–ç‰‡
    commandMessage = "ğŸºğŸºğŸºğŸºğŸºç”¢ç”Ÿ QRCode åœ–ç‰‡"
    command = "qrencode -s 16 -o #{qrCodeImagePath} #{qrcode_download_url}"
    callOut_Command(COMMAND:command , COMMAND_MESSAGE:commandMessage)
# åœ¨ QRCode åœ–ç‰‡ åŠ å­—
    commandMessage = "ğŸºğŸºğŸºğŸºğŸºåœ¨ QRCode åœ–ç‰‡ åŠ ç¬¬ä¸€è¡Œå­—"
    command = "convert -fill red \
    -pointsize 17 \
    -resize 350x350 \
    -font è˜‹æ–¹-ç¹-çº–ç´°é«” \
    -gravity center \
    -draw 'text 0,150 'A03_iOS_#{environment}'' qrCode.png \
    qrCode.png"
    # å°å°æ”¹åœ–çš„åŠŸèƒ½,æ‰“åŒ…æ©Ÿæ²’æœ‰å®‰è£æ­¤å¥—ä»¶
    callOut_Command(COMMAND:command , COMMAND_MESSAGE:commandMessage)
    
    commandMessage = "ğŸºğŸºğŸºğŸºğŸºåœ¨ QRCode åœ–ç‰‡ åŠ ç¬¬äºŒè¡Œå­—"
    command = "convert -fill orange \
    -pointsize 15 \
    -resize 350x350 \
    -font Arial \
    -gravity center \
    -draw 'text 0,167 'v#{app_version}'' qrCode.png \
    qrCode.png"
    # å°å°æ”¹åœ–çš„åŠŸèƒ½,æ‰“åŒ…æ©Ÿæ²’æœ‰å®‰è£æ­¤å¥—ä»¶
    callOut_Command(COMMAND:command , COMMAND_MESSAGE:commandMessage)
	
# å›¾ç‰‡ base64 ç¼–ç ï¼Œå¹¶å»é™¤ç©ºè¡Œ \n å’Œç©ºæ ¼
#	qrcodeBase64Text = sh("openssl base64 -in #{qrCodeImagePath} | xargs echo -n | tr -d '[:space:]'")
#	puts "äºŒç»´ç å›¾ç‰‡ base64: #{qrcodeBase64Text} "	
#	qrcodeBase64 = "data:image/png;base64,#{qrcodeBase64Text}"
#	puts "å›¾ç‰‡ base64: #{qrcodeBase64} "
#	env_file = File.join(File.expand_path("", __FILE__), "qrCode.png")
#	puts "app: #{env_file} "
# æ–‡å­—æº–å‚™
    UI.message "ğŸºğŸºğŸºğŸºğŸºæ–‡å­—æº–å‚™"
    appIdString = '{ "appId" : "A03" }'
    authorizationString = '{ "Authorization" : "Bearer S7BG2g5Cn6MJLD6Obce2p/Ma7BJ5K8BnyBRLKkMPgZA=" }'
    content_String = '{ "Content-Type" : "text/plain" }'
    gitDiffString = sh("git log -1 --stat --no-merges --pretty=format:'%s(%an)' master..#{git_branch}").delete("\n")
    #gitDiffString = sh("git log --pretty=format:'%s(%an)' $(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1))..$(git describe --abbrev=0)")
    UI.message "ğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºç¬¬ä¸€ç§\n #{gitDiffString}\nğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸº"
    
    gitDiffStringTwo = changelog_from_git_commits(
        between: ["#{short_hash}", "master"],
        pretty: "%s(%an)",
        date_format: "short",
        match_lightweight_tag: false,
        merge_commit_filtering: "exclude_merges"
        ).delete("\n")
    
    UI.message "ğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºç¬¬äºŒç§\n #{gitDiffStringTwo}\nğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸº"
    
# æ–‡å­—ä»£å· ä¼ è¾“ ç”¨ %()
    #receiverString = %({ "receiver" : "{FD375D42-F34C-43C9-951C-334F1510A69B}" ,"content" : "ğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸº\\nå½“å‰åˆ†æ”¯: #{git_branch}, \\nå‘å¸ƒç¯å¢ƒ : A03_#{environment} , \\nå‘å¸ƒç‰ˆæœ¬è™Ÿ: #{app_version},  \\nå‘å¸ƒå»ºç½®è™Ÿ: #{build_number},  \\nå‘å¸ƒåç§°: #{ipa_Name},  \\nå‘å¸ƒä¸‹è½½ç½‘å€: #{download_url}\\nğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸºğŸº" })
    receiverString = %({ "receiver" : "#{@receiverName}" ,"content" : "ã€A01Nike_iOSã€‘ã€A03_#{environment}ã€‘ã€åˆ†æ”¯ï¼š#{git_branch}ã€‘æ‰“åŒ…æˆåŠŸ!!! #{build_number}\\n-----------------------------------------------------------\\n#{gitDiffString}"})
        UI.message "ğŸºğŸºğŸº#{receiverString}ğŸºğŸºğŸº"

# è½‰æ›æˆjsonæ ¼å¼
    UI.message "ğŸºğŸºğŸºğŸºğŸºè½‰æ›æˆjsonæ ¼å¼"
    appIDJson = JSON.parse(appIdString)
    authorizationJson = JSON.parse(authorizationString)
    content_Json = JSON.parse(content_String)
    receiver_Json = JSON.parse(receiverString)
    #UI.message "ğŸºğŸº#{receiver_Json}ğŸº"
    
# ä»£å…¥
    commandMessage = "ğŸºğŸºğŸºğŸºğŸºå‘¼å«iTalk,ä¼ é€è®¯æ¯"
    command = "curl -X POST http://10.82.64.30:8000/api/italk/send -H 'appid: A01' \
      -H 'authorization: Bearer S7BG2g5Cn6MJLD6Obce2p/Ma7BJ5K8BnyBRLKkMPgZA=' \
      -H 'cache-control: no-cache' \
      -H 'content-type: application/json' \
      -H 'postman-token: 1e650d7e-71e4-8329-827d-e4aea0c30050' \
      -d '#{receiverString}'"
    callOut_Command(COMMAND:command , COMMAND_MESSAGE:commandMessage)

    commandMessage = "ğŸºğŸºğŸºğŸºğŸºå‘¼å«iTalk,ä¼ é€å›¾ç‰‡"
    command = "curl -X POST http://10.82.64.30:8000/api/italk/sendFile -H 'appid: A01' \
      -H 'authorization: Bearer S7BG2g5Cn6MJLD6Obce2p/Ma7BJ5K8BnyBRLKkMPgZA=' \
      -H 'content-type: multipart/form-data' \
      -F receiver=#{@receiverName} \
      -F file=@#{qrCodeImagePath} \
      -F type=image"
    callOut_Command(COMMAND:command , COMMAND_MESSAGE:commandMessage)
   end
   
   # ä¸»è¦å‘¼å«çš„é›†åˆæ–¹æ³•
   lane :callOut_Command do |options|
      callback = lambda do |result|
      error_occurred = true
      UI.error "ğŸ’¦ğŸ‘‹#{@innerCommandMessage}\næ‰§è¡Œå¤±è´¥åœ¨ä¸‹åˆ—ç¨‹å¼ç \n #{@innerCommand}" if error_occurred
      callOut_ErrorHandler(COMMAND:@innerCommand , COMMAND_MESSAGE:@innerCommandMessage)
      end
      
        @innerCommandMessage=options[:COMMAND_MESSAGE]
        @innerCommand=options[:COMMAND]
        UI.message "#{@innerCommandMessage}"
        error_occurred = false
        sh(
        @innerCommand,
        print_command_output: false,
        error_callback:callback
        )

   end

   # éŒ¯èª¤é›†åˆæ–¹æ³•
   error do |lane, exception|
   # å½“å‰Gitåç§°
    commandMessage = "#{exception.to_s}"
    callOut_ErrorHandler(COMMAND:"ç¼–è¯‘é”™è¯¯" , COMMAND_MESSAGE:commandMessage)
   end

   # æœ¬åœ°ç”¨çš„éŒ¯èª¤é›†åˆæ–¹æ³•,èˆ‡ä¸€èˆ¬å‘¼å«æ–¹æ³•åˆ†é–‹,é¿å…åŸ·è¡Œç·’è¡çª
   lane :callOut_ErrorHandler do |options|
     command=options[:COMMAND]
     commandMessage=options[:COMMAND_MESSAGE]
     finalCommandMessage = "XA01å½“å‰åˆ†æ”¯å‘ç”Ÿé”™è¯¯: #{git_branch} ,\\né”™è¯¯åŸå› :#{commandMessage}"
   # æ–‡å­—ä»£å· ä¼ è¾“ ç”¨ %()
     receiverString = %({ "receiver" : "#{@receiverName}" ,"content" : "#{finalCommandMessage}" })
     finalcommand = "curl -X POST http://10.82.64.30:8000/api/italk/send -H 'appid: A01' \
      -H 'authorization: Bearer S7BG2g5Cn6MJLD6Obce2p/Ma7BJ5K8BnyBRLKkMPgZA=' \
      -H 'cache-control: no-cache' \
      -H 'content-type: application/json' \
      -H 'postman-token: 1e650d7e-71e4-8329-827d-e4aea0c30050' \
      -d '#{receiverString}'"
     sh(
        finalcommand,
        print_command_output: false
     )
   end
end

